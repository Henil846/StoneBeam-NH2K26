/**
 * Request Quotations - Form Handler and Validation
 * StoneBeam-NH Construction Management
 */

document.addEventListener('DOMContentLoaded', () => {
    
    const form = document.getElementById('quotationForm');
    const progressFill = document.getElementById('progressFill');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    
    let uploadedFiles = [];
    let formProgress = 0;
    
    // Initialize form
    init();
    
    function init() {
        setupEventListeners();
        updateProgress();
        checkForEditMode();
        populateUserInfo();
    }
    
    function setupEventListeners() {\n        // Form submission\n        if (form) {\n            form.addEventListener('submit', handleFormSubmit);\n        }\n        \n        // File upload\n        if (fileInput) {\n            fileInput.addEventListener('change', handleFileUpload);\n        }\n        \n        // Form field changes for progress tracking\n        const formFields = form.querySelectorAll('input, select, textarea');\n        formFields.forEach(field => {\n            field.addEventListener('input', updateProgress);\n            field.addEventListener('change', updateProgress);\n        });\n        \n        // Auto-save draft\n        setInterval(saveDraft, 30000); // Save every 30 seconds\n    }\n    \n    function handleFormSubmit(e) {\n        e.preventDefault();\n        \n        if (!validateForm()) {\n            return;\n        }\n        \n        const formData = collectFormData();\n        submitQuotationRequest(formData);\n    }\n    \n    function validateForm() {\n        const requiredFields = [\n            'projectTitle',\n            'projectType',\n            'projectDescription',\n            'address',\n            'city',\n            'fullName',\n            'email',\n            'phone'\n        ];\n        \n        let isValid = true;\n        const errors = [];\n        \n        requiredFields.forEach(fieldId => {\n            const field = document.getElementById(fieldId);\n            if (!field || !field.value.trim()) {\n                isValid = false;\n                errors.push(`${fieldId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())} is required`);\n                \n                if (field) {\n                    field.style.borderColor = '#e74c3c';\n                    setTimeout(() => {\n                        field.style.borderColor = '';\n                    }, 3000);\n                }\n            }\n        });\n        \n        // Validate email\n        const emailField = document.getElementById('email');\n        if (emailField && emailField.value && !isValidEmail(emailField.value)) {\n            isValid = false;\n            errors.push('Please enter a valid email address');\n            emailField.style.borderColor = '#e74c3c';\n        }\n        \n        // Validate phone\n        const phoneField = document.getElementById('phone');\n        if (phoneField && phoneField.value && !isValidPhone(phoneField.value)) {\n            isValid = false;\n            errors.push('Please enter a valid phone number');\n            phoneField.style.borderColor = '#e74c3c';\n        }\n        \n        if (!isValid) {\n            showNotification('Please fix the following errors:\\n' + errors.join('\\n'), 'error');\n        }\n        \n        return isValid;\n    }\n    \n    function collectFormData() {\n        const formData = {\n            id: 'req_' + Date.now(),\n            projectTitle: document.getElementById('projectTitle').value,\n            projectType: document.getElementById('projectType').value,\n            budget: document.getElementById('budget').value,\n            projectDescription: document.getElementById('projectDescription').value,\n            address: document.getElementById('address').value,\n            city: document.getElementById('city').value,\n            projectLocation: `${document.getElementById('city').value}`,\n            startDate: document.getElementById('startDate').value,\n            deadline: document.getElementById('deadline').value,\n            fullName: document.getElementById('fullName').value,\n            email: document.getElementById('email').value,\n            phone: document.getElementById('phone').value,\n            preferredContact: document.getElementById('preferredContact').value,\n            urgentProject: document.getElementById('urgentProject').checked,\n            specialRequirements: document.getElementById('specialRequirements').value,\n            verifiedOnly: document.getElementById('verifiedOnly').checked,\n            latitude: document.getElementById('latitude').value,\n            longitude: document.getElementById('longitude').value,\n            files: uploadedFiles,\n            status: 'pending',\n            createdAt: new Date().toISOString(),\n            updatedAt: new Date().toISOString()\n        };\n        \n        return formData;\n    }\n    \n    function submitQuotationRequest(formData) {\n        // Show loading state\n        const submitBtn = form.querySelector('button[type=\"submit\"]');\n        const originalText = submitBtn.innerHTML;\n        submitBtn.innerHTML = '<i class=\"fa-solid fa-spinner fa-spin\"></i> Submitting Request...';\n        submitBtn.disabled = true;\n        \n        // Simulate API call\n        setTimeout(() => {\n            try {\n                // Save to localStorage (in production, this would be an API call)
                const existingRequests = JSON.parse(localStorage.getItem('user_requests') || '[]');
                existingRequests.push(formData);
                localStorage.setItem('user_requests', JSON.stringify(existingRequests));
                
                // Notify dealers about new request
                if (window.notificationSystem) {
                    notificationSystem.notifyDealersNewRequest(formData);
                }
                
                // Clear draft
                localStorage.removeItem('quotation_draft');
                
                // Show success message
                showNotification('Quotation request submitted successfully!', 'success');\n                \n                // Redirect to view quotations page\n                setTimeout(() => {\n                    window.location.href = 'view-quotations.html';\n                }, 2000);\n                \n            } catch (error) {\n                console.error('Error submitting request:', error);\n                showNotification('Error submitting request. Please try again.', 'error');\n                \n                submitBtn.innerHTML = originalText;\n                submitBtn.disabled = false;\n            }\n        }, 2000);\n    }\n    \n    function handleFileUpload(e) {\n        const files = Array.from(e.target.files);\n        \n        files.forEach(file => {\n            // Validate file\n            if (!validateFile(file)) {\n                return;\n            }\n            \n            // Add to uploaded files\n            const fileData = {\n                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),\n                name: file.name,\n                size: file.size,\n                type: file.type,\n                uploadedAt: new Date().toISOString()\n            };\n            \n            uploadedFiles.push(fileData);\n            \n            // Update file list display\n            updateFileList();\n        });\n        \n        // Clear input\n        e.target.value = '';\n    }\n    \n    function validateFile(file) {\n        const maxSize = 10 * 1024 * 1024; // 10MB\n        const allowedTypes = [\n            'application/pdf',\n            'image/jpeg',\n            'image/png',\n            'image/jpg',\n            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n            'application/msword'\n        ];\n        \n        if (file.size > maxSize) {\n            showNotification(`File \"${file.name}\" is too large. Maximum size is 10MB.`, 'error');\n            return false;\n        }\n        \n        if (!allowedTypes.includes(file.type)) {\n            showNotification(`File \"${file.name}\" has an unsupported format.`, 'error');\n            return false;\n        }\n        \n        return true;\n    }\n    \n    function updateFileList() {\n        if (!fileList) return;\n        \n        if (uploadedFiles.length === 0) {\n            fileList.innerHTML = '';\n            return;\n        }\n        \n        fileList.innerHTML = uploadedFiles.map(file => `\n            <div class=\"file-item\">\n                <div class=\"file-info\">\n                    <i class=\"fa-solid fa-file\"></i>\n                    <span>${file.name}</span>\n                    <small>(${formatFileSize(file.size)})</small>\n                </div>\n                <button type=\"button\" onclick=\"removeFile('${file.id}')\">\n                    <i class=\"fa-solid fa-times\"></i>\n                </button>\n            </div>\n        `).join('');\n    }\n    \n    function updateProgress() {\n        const totalFields = 12; // Total number of important fields\n        let filledFields = 0;\n        \n        const importantFields = [\n            'projectTitle',\n            'projectType',\n            'projectDescription',\n            'address',\n            'city',\n            'fullName',\n            'email',\n            'phone'\n        ];\n        \n        importantFields.forEach(fieldId => {\n            const field = document.getElementById(fieldId);\n            if (field && field.value.trim()) {\n                filledFields++;\n            }\n        });\n        \n        // Add points for optional fields\n        if (document.getElementById('budget').value) filledFields++;\n        if (document.getElementById('startDate').value) filledFields++;\n        if (document.getElementById('deadline').value) filledFields++;\n        if (uploadedFiles.length > 0) filledFields++;\n        \n        formProgress = Math.min((filledFields / totalFields) * 100, 100);\n        \n        if (progressFill) {\n            progressFill.style.width = formProgress + '%';\n        }\n    }\n    \n    function saveDraft() {\n        if (formProgress > 10) { // Only save if user has started filling\n            const draftData = collectFormData();\n            localStorage.setItem('quotation_draft', JSON.stringify(draftData));\n        }\n    }\n    \n    function loadDraft() {\n        const draft = localStorage.getItem('quotation_draft');\n        if (!draft) return;\n        \n        try {\n            const draftData = JSON.parse(draft);\n            \n            // Populate form fields\n            Object.keys(draftData).forEach(key => {\n                const field = document.getElementById(key);\n                if (field) {\n                    if (field.type === 'checkbox') {\n                        field.checked = draftData[key];\n                    } else {\n                        field.value = draftData[key];\n                    }\n                }\n            });\n            \n            // Restore uploaded files\n            if (draftData.files) {\n                uploadedFiles = draftData.files;\n                updateFileList();\n            }\n            \n            updateProgress();\n            showNotification('Draft restored', 'info');\n            \n        } catch (error) {\n            console.error('Error loading draft:', error);\n        }\n    }\n    \n    function checkForEditMode() {\n        const urlParams = new URLSearchParams(window.location.search);\n        const editId = urlParams.get('edit');\n        \n        if (editId) {\n            loadRequestForEdit(editId);\n        } else {\n            // Check for draft\n            if (localStorage.getItem('quotation_draft')) {\n                if (confirm('You have a saved draft. Would you like to restore it?')) {\n                    loadDraft();\n                }\n            }\n        }\n    }\n    \n    function loadRequestForEdit(requestId) {\n        const requests = JSON.parse(localStorage.getItem('user_requests') || '[]');\n        const request = requests.find(r => r.id === requestId);\n        \n        if (!request) {\n            showNotification('Request not found', 'error');\n            return;\n        }\n        \n        // Populate form with existing data\n        Object.keys(request).forEach(key => {\n            const field = document.getElementById(key);\n            if (field) {\n                if (field.type === 'checkbox') {\n                    field.checked = request[key];\n                } else {\n                    field.value = request[key];\n                }\n            }\n        });\n        \n        // Restore files\n        if (request.files) {\n            uploadedFiles = request.files;\n            updateFileList();\n        }\n        \n        // Update form title\n        const pageTitle = document.querySelector('h1');\n        if (pageTitle) {\n            pageTitle.innerHTML = '<i class=\"fa-solid fa-edit\"></i> Edit Quotation Request';\n        }\n        \n        // Update submit button\n        const submitBtn = form.querySelector('button[type=\"submit\"]');\n        if (submitBtn) {\n            submitBtn.innerHTML = '<i class=\"fa-solid fa-save\"></i> Update Request';\n        }\n        \n        updateProgress();\n    }\n    \n    function populateUserInfo() {\n        // Auto-populate user info if logged in\n        const currentUser = JSON.parse(sessionStorage.getItem('sb_currentUser') || 'null');\n        \n        if (currentUser) {\n            const nameField = document.getElementById('fullName');\n            const emailField = document.getElementById('email');\n            const phoneField = document.getElementById('phone');\n            \n            if (nameField && !nameField.value) {\n                nameField.value = currentUser.displayName || currentUser.name || '';\n            }\n            \n            if (emailField && !emailField.value) {\n                emailField.value = currentUser.email || '';\n            }\n            \n            if (phoneField && !phoneField.value && currentUser.phone) {\n                phoneField.value = currentUser.phone;\n            }\n        }\n    }\n    \n    // Utility functions\n    function isValidEmail(email) {\n        const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n        return emailRegex.test(email);\n    }\n    \n    function isValidPhone(phone) {\n        const phoneRegex = /^[\\+]?[1-9][\\d]{0,15}$/;\n        return phoneRegex.test(phone.replace(/[\\s\\-\\(\\)]/g, ''));\n    }\n    \n    function formatFileSize(bytes) {\n        if (bytes === 0) return '0 Bytes';\n        const k = 1024;\n        const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n        const i = Math.floor(Math.log(bytes) / Math.log(k));\n        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n    }\n    \n    function showNotification(message, type = 'info') {\n        // Create notification element\n        const notification = document.createElement('div');\n        notification.className = `notification notification-${type}`;\n        notification.style.cssText = `\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};\n            color: white;\n            padding: 15px 20px;\n            border-radius: 8px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n            z-index: 1000;\n            max-width: 300px;\n            transform: translateX(400px);\n            transition: transform 0.3s ease;\n        `;\n        \n        notification.innerHTML = `\n            <div style=\"display: flex; align-items: center; gap: 10px;\">\n                <i class=\"fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}\"></i>\n                <span>${message}</span>\n                <button onclick=\"this.parentElement.parentElement.remove()\" style=\"background: none; border: none; color: white; cursor: pointer; margin-left: auto;\">\n                    <i class=\"fa-solid fa-times\"></i>\n                </button>\n            </div>\n        `;\n        \n        document.body.appendChild(notification);\n        \n        // Show notification\n        setTimeout(() => {\n            notification.style.transform = 'translateX(0)';\n        }, 100);\n        \n        // Auto remove after 5 seconds\n        setTimeout(() => {\n            notification.style.transform = 'translateX(400px)';\n            setTimeout(() => notification.remove(), 300);\n        }, 5000);\n    }\n    \n    // Global functions for button clicks\n    window.removeFile = function(fileId) {\n        uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);\n        updateFileList();\n        updateProgress();\n    };\n    \n    // Auto-save on page unload\n    window.addEventListener('beforeunload', () => {\n        if (formProgress > 10) {\n            saveDraft();\n        }\n    });\n    \n});